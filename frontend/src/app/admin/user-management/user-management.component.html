<div class="user-management-page">
  <div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="fw-bold mb-1">Gestión de Usuarios</h3>
        <p class="text-muted mb-0">Administra los usuarios del sistema</p>
      </div>
      <div>
        <!-- Placeholder for Add User Button - Implement when add functionality is ready -->
        <!-- <button class="btn btn-primary rounded-pill px-4 d-flex align-items-center" (click)="openAddUserModal(addUserModalContent)">
          <i class="bi bi-plus-circle me-2"></i> Nuevo Usuario
        </button> -->
         <button class="btn btn-primary rounded-pill px-4 d-flex align-items-center disabled" title="Add User functionality not implemented yet">
          <i class="bi bi-plus-circle me-2"></i> Nuevo Usuario
        </button>
      </div>
    </div>

    <!-- Filter Panel -->
    <div class="bg-white p-3 rounded-4 shadow-sm mb-4">
      <div class="row g-3">
        <div class="col-md-5">
          <div class="search-box position-relative">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
            <input
              type="text"
              class="form-control ps-5 rounded-pill"
              placeholder="Buscar por nombre o email..."
              [(ngModel)]="searchTerm"
              (input)="applyFilters()"
            >
          </div>
        </div>
        <div class="col-md-4">
          <select
            class="form-select rounded-pill"
            [(ngModel)]="filterRole"
            (change)="applyFilters()"
          >
            <option value="">Todos los roles</option>
            <option value="ROLE_USER">Usuario</option>
            <option value="ROLE_EMPLOYEE">Empleado</option>
            <option value="ROLE_ADMIN">Admin</option>
            <!-- Add other roles if they exist -->
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-secondary rounded-pill w-100" (click)="resetFilters()">
            <i class="bi bi-x-circle me-1"></i> Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2 text-muted">Cargando usuarios...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>{{ error }}</div>
      <button type="button" class="btn-close ms-auto" (click)="error = null" aria-label="Close"></button>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !error && filteredUsers.length === 0" class="text-center p-5 bg-white rounded-4 shadow-sm">
      <div class="empty-state mb-3">
         <i class="bi bi-people fs-1 text-muted"></i>
      </div>
      <h5>No se encontraron usuarios</h5>
      <p class="text-muted">Intenta con otros filtros.</p>
       <!-- Add button placeholder if needed -->
       <!-- <button class="btn btn-primary rounded-pill mt-3 disabled">
         <i class="bi bi-plus-circle me-2"></i> Añadir Usuario
       </button> -->
    </div>

    <!-- Users Table -->
    <div *ngIf="!isLoading && !error && filteredUsers.length > 0" class="table-responsive bg-white rounded-4 shadow-sm">
      <table class="table table-hover mb-0 align-middle">
        <thead>
          <tr>
            <th class="ps-4">ID</th>
            <th>Email</th>
            <th>Nombre Completo</th>
            <th>Roles</th>
            <th class="text-end pe-4">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers | slice:(currentPage-1)*pageSize:currentPage*pageSize">
            <td class="ps-4 fw-bold">{{ user.id }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.fullName }}</td> <!-- Changed to fullName -->
            <td>
              <!-- Display roles more nicely -->
              <span *ngFor="let role of user.roles" class="badge rounded-pill me-1"
                    [ngClass]="{
                      'bg-primary bg-opacity-75': role === 'ROLE_ADMIN',
                      'bg-info text-dark': role === 'ROLE_EMPLOYEE',
                      'bg-secondary': role === 'ROLE_USER'
                    }">
                {{ role.replace('ROLE_', '') }}
              </span>
            </td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-outline-primary rounded-pill me-2" (click)="openEditUserModal(editUserModalContent, user)">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-outline-danger rounded-pill" (click)="openDeleteUserModal(deleteUserModalContent, user)">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="!isLoading && filteredUsers.length > 0 && totalPages > 1" class="d-flex justify-content-between align-items-center mt-4">
      <div class="text-muted small">
        Mostrando {{ filteredUsers.length }} de {{ totalUsers }} usuarios
      </div>
      <nav aria-label="Navegación de páginas de usuarios">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)">
              <i class="bi bi-chevron-left small"></i>
            </a>
          </li>
          <ng-container *ngFor="let page of getPageArray()">
            <li class="page-item" [class.active]="page === currentPage">
              <a class="page-link" href="javascript:void(0)" (click)="changePage(page)">{{ page }}</a>
            </li>
          </ng-container>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)">
              <i class="bi bi-chevron-right small"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div> <!-- Closing container-fluid -->
</div> <!-- Closing user-management-page -->

<!-- Edit User Modal -->
<ng-template #editUserModalContent let-modal>
  <div class="modal-header border-0 pb-0">
    <h5 class="modal-title fw-bold" id="modal-edit-user-title">Editar Usuario</h5>
    <button type="button" class="btn-close" aria-label="Cerrar" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body" *ngIf="selectedUser">
    <form #editUserForm="ngForm" (ngSubmit)="updateUser()" class="needs-validation" novalidate>
      <div class="mb-3">
        <label for="editUserId" class="form-label">ID</label>
        <input type="text" class="form-control form-control-lg rounded-3" id="editUserId" [value]="selectedUser.id" readonly disabled>
      </div>
      <div class="mb-3">
        <label for="editUserFullname" class="form-label">Nombre Completo</label>
        <input type="text" class="form-control form-control-lg rounded-3" id="editUserFullname" name="fullName"
               [(ngModel)]="selectedUser.fullName" required #fullName="ngModel"> <!-- Changed name and ngModel -->
        <div *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)" class="invalid-feedback d-block"> <!-- Changed variable name -->
          El nombre completo es obligatorio.
        </div>
      </div>
      <div class="mb-3">
        <label for="editUserEmail" class="form-label">Email</label>
        <input type="email" class="form-control form-control-lg rounded-3" id="editUserEmail" name="email"
               [(ngModel)]="selectedUser.email" required email #email="ngModel">
         <div *ngIf="email.invalid && (email.dirty || email.touched)" class="invalid-feedback d-block">
           <span *ngIf="email.errors?.['required']">El email es obligatorio.</span>
           <span *ngIf="email.errors?.['email']">Introduce un email válido.</span>
         </div>
      </div>
      <div class="mb-4">
        <label class="form-label">Roles</label>
        <!-- Simple display for now, could be checkboxes for modification -->
         <div class="bg-light p-3 rounded-3">
            <span *ngFor="let role of selectedUser.roles" class="badge rounded-pill me-1"
                  [ngClass]="{
                    'bg-primary bg-opacity-75': role === 'ROLE_ADMIN',
                    'bg-info text-dark': role === 'ROLE_EMPLOYEE',
                    'bg-secondary': role === 'ROLE_USER'
                  }">
              {{ role.replace('ROLE_', '') }}
            </span>
         </div>
         <small class="text-muted">La modificación de roles requiere lógica adicional.</small>
         <!-- Example Checkbox (requires handling in component updateUser method)
         <div class="form-check">
           <input class="form-check-input" type="checkbox" value="ROLE_ADMIN" id="roleAdmin"
                  [checked]="selectedUser.roles.includes('ROLE_ADMIN')" (change)="toggleRole('ROLE_ADMIN')">
           <label class="form-check-label" for="roleAdmin">Admin</label>
         </div>
         -->
      </div>

      <!-- Display error message within modal -->
       <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3 mb-3">
         <i class="bi bi-exclamation-triangle-fill me-2"></i>
         <div>{{ error }}</div>
       </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg" [disabled]="editUserForm.invalid || isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Guardar Cambios
        </button>
        <button type="button" class="btn btn-light btn-lg" (click)="modal.dismiss('Cancel click')">Cancelar</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Delete User Modal -->
<ng-template #deleteUserModalContent let-modal>
   <div class="modal-body text-center p-5" *ngIf="selectedUser">
     <button type="button" class="btn-close position-absolute top-0 end-0 p-3" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
     <div class="modal-icon bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-4">
       <i class="bi bi-trash fs-1"></i>
     </div>
     <h3 class="fw-bold mb-3">¿Eliminar usuario?</h3>
     <p class="text-muted mb-4">¿Estás seguro de que quieres eliminar al usuario <span class="fw-bold">{{ selectedUser.fullName }} ({{ selectedUser.email }})</span>? Esta acción no se puede deshacer.</p> <!-- Changed to fullName -->

     <!-- Display error message within modal -->
     <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3 mb-3">
       <i class="bi bi-exclamation-triangle-fill me-2"></i>
       <div>{{ error }}</div>
     </div>

     <div class="d-flex gap-3">
       <button type="button" class="btn btn-light btn-lg flex-fill" (click)="modal.dismiss('Cancel click')">Cancelar</button>
       <button type="button" class="btn btn-danger btn-lg flex-fill" (click)="deleteUser()" [disabled]="isSubmitting">
         <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
         Eliminar
       </button>
     </div>
   </div>
</ng-template>