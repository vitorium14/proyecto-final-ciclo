<div class="reservation-management-page">
  <div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="fw-bold mb-1">Gestión de Reservas</h3>
        <p class="text-muted mb-0">Administra las reservas del hotel</p>
      </div>
      <div>
        <!-- Add Reservation Button - Usually handled by user booking flow -->
        <!-- <button class="btn btn-primary rounded-pill px-4 d-flex align-items-center disabled" title="Add Reservation functionality handled elsewhere">
          <i class="bi bi-plus-circle me-2"></i> Nueva Reserva
        </button> -->
      </div>
    </div>

    <!-- Filter Panel -->
    <div class="bg-white p-3 rounded-4 shadow-sm mb-4">
      <div class="row g-3">
        <div class="col-md-5">
          <div class="search-box position-relative">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
            <input
              type="text"
              class="form-control ps-5 rounded-pill"
              placeholder="Buscar por cliente o habitación..."
              [(ngModel)]="searchTerm"
              (input)="applyFilters()"
            >
          </div>
        </div>
        <div class="col-md-4">
          <select
            class="form-select rounded-pill"
            [(ngModel)]="filterStatus"
            (change)="applyFilters()"
          >
            <option value="">Todos los estados</option>
            <option *ngFor="let status of availableStatuses" [value]="status">{{ getStatusLabel(status) }}</option>
          </select>
        </div>
        <!-- TODO: Add Date Range Filter Inputs if needed -->
        <!-- <div class="col-md-X"> ... date inputs ... </div> -->
        <div class="col-md-3">
          <button class="btn btn-outline-secondary rounded-pill w-100" (click)="resetFilters()">
            <i class="bi bi-x-circle me-1"></i> Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2 text-muted">Cargando reservas...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>{{ error }}</div>
      <button type="button" class="btn-close ms-auto" (click)="error = null" aria-label="Close"></button>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !error && filteredReservations.length === 0" class="text-center p-5 bg-white rounded-4 shadow-sm">
       <div class="empty-state mb-3">
         <i class="bi bi-calendar-x fs-1 text-muted"></i>
      </div>
      <h5>No se encontraron reservas</h5>
      <p class="text-muted">Intenta con otros filtros.</p>
    </div>

    <!-- Reservations Table -->
    <div *ngIf="!isLoading && !error && filteredReservations.length > 0" class="table-responsive bg-white rounded-4 shadow-sm">
      <table class="table table-hover mb-0 align-middle">
        <thead>
          <tr>
            <th class="ps-4">ID</th>
            <th>Cliente</th>
            <th>Habitación</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Estado</th>
            <th class="text-end pe-4">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let reservation of filteredReservations | slice:(currentPage-1)*pageSize:currentPage*pageSize">
            <td class="ps-4 fw-bold">{{ reservation.id }}</td>
            <td>
              <div>{{ reservation.client.fullName }}</div>
              <small class="text-muted">{{ reservation.client.email }}</small>
            </td>
            <td>Hab. {{ reservation.room.number }}</td>
            <td>{{ reservation.checkIn | date:'dd/MM/yyyy' }}</td> <!-- Use DatePipe -->
            <td>{{ reservation.checkOut | date:'dd/MM/yyyy' }}</td> <!-- Use DatePipe -->
            <td>
              <span class="badge rounded-pill" [ngClass]="getStatusClass(reservation.status)">
                {{ getStatusLabel(reservation.status) }}
              </span>
            </td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-outline-primary rounded-pill me-2" (click)="openEditReservationModal(editReservationModalContent, reservation)">
                <i class="bi bi-pencil"></i> Editar Estado
              </button>
              <button class="btn btn-sm btn-outline-danger rounded-pill" (click)="openDeleteReservationModal(deleteReservationModalContent, reservation)">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="!isLoading && filteredReservations.length > 0 && totalPages > 1" class="d-flex justify-content-between align-items-center mt-4">
      <div class="text-muted small">
        Mostrando {{ filteredReservations.length }} de {{ totalReservations }} reservas
      </div>
      <nav aria-label="Navegación de páginas de reservas">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)">
              <i class="bi bi-chevron-left small"></i>
            </a>
          </li>
          <ng-container *ngFor="let page of getPageArray()">
            <li class="page-item" [class.active]="page === currentPage">
              <a class="page-link" href="javascript:void(0)" (click)="changePage(page)">{{ page }}</a>
            </li>
          </ng-container>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)">
              <i class="bi bi-chevron-right small"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div> <!-- Closing container-fluid -->
</div> <!-- Closing reservation-management-page -->

<!-- Edit Reservation Modal (Focus on Status) -->
<ng-template #editReservationModalContent let-modal>
  <div class="modal-header border-0 pb-0">
    <h5 class="modal-title fw-bold" id="modal-edit-reservation-title">Editar Estado Reserva</h5>
    <button type="button" class="btn-close" aria-label="Cerrar" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body" *ngIf="selectedReservation">
    <form #editReservationForm="ngForm" (ngSubmit)="updateReservation()" class="needs-validation" novalidate>
      <div class="mb-3">
        <label class="form-label">Reserva ID</label>
        <input type="text" class="form-control form-control-lg rounded-3" [value]="selectedReservation.id" readonly disabled>
      </div>
       <div class="mb-3">
        <label class="form-label">Cliente</label>
        <input type="text" class="form-control form-control-lg rounded-3" [value]="selectedReservation.client.fullName + ' (' + selectedReservation.client.email + ')'" readonly disabled>
      </div>
       <div class="row g-3 mb-3">
         <div class="col-md-6">
           <label class="form-label">Check-in</label>
           <input type="text" class="form-control form-control-lg rounded-3" [value]="selectedReservation.checkIn | date:'dd/MM/yyyy'" readonly disabled>
         </div>
         <div class="col-md-6">
           <label class="form-label">Check-out</label>
           <input type="text" class="form-control form-control-lg rounded-3" [value]="selectedReservation.checkOut | date:'dd/MM/yyyy'" readonly disabled>
         </div>
       </div>
      <div class="mb-4">
        <label for="editReservationStatus" class="form-label">Estado</label>
        <select class="form-select form-select-lg rounded-3" id="editReservationStatus" name="status"
                [(ngModel)]="selectedReservation.status" required #status="ngModel">
          <option *ngFor="let stat of availableStatuses" [value]="stat">{{ getStatusLabel(stat) }}</option>
        </select>
         <div *ngIf="status.invalid && (status.dirty || status.touched)" class="invalid-feedback d-block">
           El estado es obligatorio.
         </div>
      </div>

      <!-- Display error message within modal -->
       <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3 mb-3">
         <i class="bi bi-exclamation-triangle-fill me-2"></i>
         <div>{{ error }}</div>
       </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg" [disabled]="editReservationForm.invalid || isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Actualizar Estado
        </button>
        <button type="button" class="btn btn-light btn-lg" (click)="modal.dismiss('Cancel click')">Cancelar</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Delete Reservation Modal -->
<ng-template #deleteReservationModalContent let-modal>
   <div class="modal-body text-center p-5" *ngIf="selectedReservation">
     <button type="button" class="btn-close position-absolute top-0 end-0 p-3" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
     <div class="modal-icon bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-4">
       <i class="bi bi-trash fs-1"></i>
     </div>
     <h3 class="fw-bold mb-3">¿Eliminar reserva?</h3>
     <p class="text-muted mb-4">¿Estás seguro de que quieres eliminar la reserva #{{ selectedReservation.id }} para <span class="fw-bold">{{ selectedReservation.client.fullName }}</span>? Esta acción no se puede deshacer.</p>

     <!-- Display error message within modal -->
     <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3 mb-3">
       <i class="bi bi-exclamation-triangle-fill me-2"></i>
       <div>{{ error }}</div>
     </div>

     <div class="d-flex gap-3">
       <button type="button" class="btn btn-light btn-lg flex-fill" (click)="modal.dismiss('Cancel click')">Cancelar</button>
       <button type="button" class="btn btn-danger btn-lg flex-fill" (click)="deleteReservation()" [disabled]="isSubmitting">
         <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
         Eliminar
       </button>
     </div>
   </div>
</ng-template>