<div class="service-management-page">
  <div class="container-fluid px-4">
    <!-- Header con título y botón de añadir -->
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
      <div>
        <h3 class="fw-bold mb-1">Gestión de Servicios</h3>
        <p class="text-muted mb-0">Administra los servicios ofrecidos</p>
      </div>
      <div>
        <button class="btn btn-primary rounded-pill px-4 d-flex align-items-center" (click)="openAddServiceModal(addServiceModalContent)">
          <i class="bi bi-plus-circle me-2"></i> Nuevo Servicio
        </button>
      </div>
    </div>

    <!-- Panel de filtros y búsqueda -->
    <div class="filter-panel mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-5">
          <div class="search-box position-relative">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
            <input
              type="text"
              class="form-control ps-5 rounded-pill"
              placeholder="Buscar servicios por nombre o descripción..."
              [(ngModel)]="searchTerm"
              (input)="applyFilters()"
            >
          </div>
        </div>
        <div class="col-md-4">
          <select
            class="form-select rounded-pill"
            [(ngModel)]="filterCategory"
            (change)="applyFilters()"
          >
            <option value="">Todas las categorías</option>
            <option value="wellness">Bienestar</option>
            <option value="food">Alimentación</option>
            <option value="activity">Actividades</option>
            <option value="amenity">Comodidades</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-secondary rounded-pill w-100" (click)="resetFilters()">
            <i class="bi bi-x-circle me-1"></i> Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Indicador de carga -->
    <div *ngIf="isLoading" class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2 text-muted">Cargando servicios...</p>
    </div>

    <!-- Mensaje de error -->
    <div *ngIf="error" class="alert alert-danger d-flex align-items-center rounded-3">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>{{ error }}</div>
      <button type="button" class="btn-close ms-auto" (click)="error = null" aria-label="Close"></button>
    </div>

    <!-- Lista de servicios en formato cuadrícula -->
    <div *ngIf="!isLoading && !error && filteredServices.length > 0" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
      <div *ngFor="let service of filteredServices | slice:(currentPage-1)*pageSize:currentPage*pageSize" class="col">
        <div class="card h-100 service-card"> <!-- Removed shadow-sm, handled by SCSS -->
          <div class="service-img-container">
            <img [src]="service.image || 'https://via.placeholder.com/300x180?text=Servicio'" class="card-img-top" alt="{{service.name}}"> <!-- Updated placeholder -->
            <div class="service-category">{{ getCategoryLabel(service.category) }}</div> <!-- Use label function -->
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{service.name}}</h5>
            <p class="card-text flex-grow-1">{{service.description}}</p> <!-- Removed text-truncate, adjusted height in SCSS -->
            <div class="d-flex justify-content-between align-items-center mt-auto pt-2">
              <span class="price">{{service.price | currency:'EUR':'symbol':'1.2-2'}}</span>
              <span *ngIf="service.duration > 0" class="duration">
                <i class="bi bi-clock me-1"></i> {{service.duration}} min
              </span>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end gap-2 py-2"> <!-- Adjusted alignment and gap -->
            <button class="btn btn-sm btn-outline-primary rounded-pill" (click)="openEditServiceModal(editServiceModalContent, service)">
              <i class="bi bi-pencil me-1"></i> Editar
            </button>
            <button class="btn btn-sm btn-outline-danger rounded-pill" (click)="openDeleteServiceModal(deleteServiceModalContent, service)">
              <i class="bi bi-trash me-1"></i> Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin resultados -->
    <div *ngIf="!isLoading && !error && filteredServices.length === 0" class="empty-state text-center">
      <i class="bi bi-emoji-frown"></i> <!-- Changed icon -->
      <h5>No se encontraron servicios</h5>
      <p class="text-muted">Intenta con otros filtros o crea un nuevo servicio.</p>
      <button class="btn btn-primary rounded-pill mt-3" (click)="openAddServiceModal(addServiceModalContent)">
        <i class="bi bi-plus-circle me-2"></i> Añadir Servicio
      </button>
    </div>

    <!-- Paginación -->
    <div *ngIf="!isLoading && filteredServices.length > 0 && totalPages > 1" class="d-flex justify-content-between align-items-center mt-4">
      <div class="text-muted small">
        Mostrando {{ filteredServices.length }} de {{ totalServices }} servicios
      </div>
      <nav aria-label="Navegación de páginas de servicios">
        <ul class="pagination pagination-sm mb-0">
          <!-- Removed First/Last buttons for simplicity, matching room-management -->
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)">
              <i class="bi bi-chevron-left small"></i>
            </a>
          </li>
          <ng-container *ngFor="let page of getPageArray()">
            <li class="page-item" [class.active]="page === currentPage">
              <a class="page-link" href="javascript:void(0)" (click)="changePage(page)">{{ page }}</a>
            </li>
          </ng-container>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)">
              <i class="bi bi-chevron-right small"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div> <!-- Closing container-fluid -->
</div> <!-- Closing service-management-page -->

<!-- Modals remain wrapped in ng-template -->

<!-- Modal para añadir servicio -->
<ng-template #addServiceModalContent let-modal>
  <div class="modal-header border-0 pb-0"> <!-- Consistent modal header style -->
    <h5 class="modal-title fw-bold" id="modal-add-service-title">Nuevo Servicio</h5>
    <button type="button" class="btn-close" aria-label="Cerrar" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <form #addServiceForm="ngForm" (ngSubmit)="addService()" class="needs-validation" novalidate>
      <div class="row g-3">
        <div class="col-md-12"> <!-- Full width name -->
          <label for="serviceName" class="form-label">Nombre del servicio</label>
          <input type="text" class="form-control form-control-lg rounded-3" id="serviceName" [(ngModel)]="newService.name" name="name" required #serviceName="ngModel">
          <div *ngIf="serviceName.invalid && (serviceName.dirty || serviceName.touched)" class="invalid-feedback d-block">
            El nombre es obligatorio.
          </div>
        </div>
        <div class="col-md-6"> <!-- Price -->
          <label for="servicePrice" class="form-label">Precio (€)</label>
           <div class="input-group">
             <span class="input-group-text">€</span>
             <input type="number" class="form-control form-control-lg rounded-end-3" id="servicePrice" [(ngModel)]="newService.price" name="price" min="0" step="0.01" required #servicePrice="ngModel">
           </div>
           <div *ngIf="servicePrice.invalid && (servicePrice.dirty || servicePrice.touched)" class="invalid-feedback d-block">
            El precio es obligatorio y debe ser 0 o mayor.
          </div>
        </div>
        <div class="col-md-6"> <!-- Duration -->
          <label for="serviceDuration" class="form-label">Duración (minutos)</label>
          <input type="number" class="form-control form-control-lg rounded-3" id="serviceDuration" [(ngModel)]="newService.duration" name="duration" min="0" #serviceDuration="ngModel">
           <div *ngIf="serviceDuration.invalid && (serviceDuration.dirty || serviceDuration.touched)" class="invalid-feedback d-block">
            La duración debe ser 0 o mayor.
          </div>
        </div>
        <div class="col-md-12"> <!-- Description -->
          <label for="serviceDescription" class="form-label">Descripción</label>
          <textarea class="form-control form-control-lg rounded-3" id="serviceDescription" rows="3" [(ngModel)]="newService.description" name="description" required #serviceDescription="ngModel"></textarea>
           <div *ngIf="serviceDescription.invalid && (serviceDescription.dirty || serviceDescription.touched)" class="invalid-feedback d-block">
            La descripción es obligatoria.
          </div>
        </div>
        <div class="col-md-6"> <!-- Category -->
          <label for="serviceCategory" class="form-label">Categoría</label>
          <select class="form-select form-select-lg rounded-3" id="serviceCategory" [(ngModel)]="newService.category" name="category" required #serviceCategory="ngModel">
            <option value="" disabled>Seleccionar categoría...</option>
            <option value="wellness">Bienestar</option>
            <option value="food">Alimentación</option>
            <option value="activity">Actividades</option>
            <option value="amenity">Comodidades</option>
          </select>
           <div *ngIf="serviceCategory.invalid && (serviceCategory.dirty || serviceCategory.touched)" class="invalid-feedback d-block">
            La categoría es obligatoria.
          </div>
        </div>
        <div class="col-md-6"> <!-- Image URL -->
          <label for="serviceImage" class="form-label">URL de imagen (Opcional)</label>
          <input type="text" class="form-control form-control-lg rounded-3" id="serviceImage" [(ngModel)]="newService.image" name="image" placeholder="https://...">
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer border-0 pt-0"> <!-- Consistent modal footer style -->
    <div class="d-grid gap-2 w-100">
      <button type="submit" class="btn btn-primary btn-lg" (click)="addService()" [disabled]="addServiceForm.invalid || isSubmitting">
        <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Guardar Servicio
      </button>
      <button type="button" class="btn btn-light btn-lg" (click)="modal.dismiss('Cancel click')">Cancelar</button>
    </div>
  </div>
</ng-template>

<!-- Modal para editar servicio -->
<ng-template #editServiceModalContent let-modal>
   <div class="modal-header border-0 pb-0">
    <h5 class="modal-title fw-bold" id="modal-edit-service-title">Editar Servicio</h5>
    <button type="button" class="btn-close" aria-label="Cerrar" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <form #editServiceForm="ngForm" (ngSubmit)="updateService()" class="needs-validation" novalidate>
       <div class="row g-3">
        <div class="col-md-12">
          <label for="editServiceName" class="form-label">Nombre del servicio</label>
          <input type="text" class="form-control form-control-lg rounded-3" id="editServiceName" [(ngModel)]="selectedService.name" name="name" required #editServiceName="ngModel">
           <div *ngIf="editServiceName.invalid && (editServiceName.dirty || editServiceName.touched)" class="invalid-feedback d-block">
            El nombre es obligatorio.
          </div>
        </div>
        <div class="col-md-6">
          <label for="editServicePrice" class="form-label">Precio (€)</label>
           <div class="input-group">
             <span class="input-group-text">€</span>
             <input type="number" class="form-control form-control-lg rounded-end-3" id="editServicePrice" [(ngModel)]="selectedService.price" name="price" min="0" step="0.01" required #editServicePrice="ngModel">
           </div>
           <div *ngIf="editServicePrice.invalid && (editServicePrice.dirty || editServicePrice.touched)" class="invalid-feedback d-block">
            El precio es obligatorio y debe ser 0 o mayor.
          </div>
        </div>
        <div class="col-md-6">
          <label for="editServiceDuration" class="form-label">Duración (minutos)</label>
          <input type="number" class="form-control form-control-lg rounded-3" id="editServiceDuration" [(ngModel)]="selectedService.duration" name="duration" min="0" #editServiceDuration="ngModel">
           <div *ngIf="editServiceDuration.invalid && (editServiceDuration.dirty || editServiceDuration.touched)" class="invalid-feedback d-block">
            La duración debe ser 0 o mayor.
          </div>
        </div>
        <div class="col-md-12">
          <label for="editServiceDescription" class="form-label">Descripción</label>
          <textarea class="form-control form-control-lg rounded-3" id="editServiceDescription" rows="3" [(ngModel)]="selectedService.description" name="description" required #editServiceDescription="ngModel"></textarea>
           <div *ngIf="editServiceDescription.invalid && (editServiceDescription.dirty || editServiceDescription.touched)" class="invalid-feedback d-block">
            La descripción es obligatoria.
          </div>
        </div>
        <div class="col-md-6">
          <label for="editServiceCategory" class="form-label">Categoría</label>
          <select class="form-select form-select-lg rounded-3" id="editServiceCategory" [(ngModel)]="selectedService.category" name="category" required #editServiceCategory="ngModel">
             <option value="" disabled>Seleccionar categoría...</option>
            <option value="wellness">Bienestar</option>
            <option value="food">Alimentación</option>
            <option value="activity">Actividades</option>
            <option value="amenity">Comodidades</option>
          </select>
           <div *ngIf="editServiceCategory.invalid && (editServiceCategory.dirty || editServiceCategory.touched)" class="invalid-feedback d-block">
            La categoría es obligatoria.
          </div>
        </div>
        <div class="col-md-6">
          <label for="editServiceImage" class="form-label">URL de imagen (Opcional)</label>
          <input type="text" class="form-control form-control-lg rounded-3" id="editServiceImage" [(ngModel)]="selectedService.image" name="image" placeholder="https://...">
        </div>
      </div>
    </form>
  </div>
   <div class="modal-footer border-0 pt-0">
    <div class="d-grid gap-2 w-100">
      <button type="submit" class="btn btn-primary btn-lg" (click)="updateService()" [disabled]="editServiceForm.invalid || isSubmitting">
        <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Actualizar Servicio
      </button>
      <button type="button" class="btn btn-light btn-lg" (click)="modal.dismiss('Cancel click')">Cancelar</button>
    </div>
  </div>
</ng-template>

<!-- Modal para eliminar servicio -->
<ng-template #deleteServiceModalContent let-modal>
   <div class="modal-body text-center p-5"> <!-- Consistent delete modal style -->
     <button type="button" class="btn-close position-absolute top-0 end-0 p-3" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
     <div class="modal-icon bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-4">
       <i class="bi bi-trash fs-1"></i>
     </div>
     <h3 class="fw-bold mb-3">¿Eliminar servicio?</h3>
     <p class="text-muted mb-4">¿Estás seguro de que quieres eliminar el servicio <span class="fw-bold">{{ selectedService.name }}</span>? Esta acción no se puede deshacer.</p>
     <div class="d-flex gap-3">
       <button type="button" class="btn btn-light btn-lg flex-fill" (click)="modal.dismiss('Cancel click')">Cancelar</button>
       <button type="button" class="btn btn-danger btn-lg flex-fill" (click)="deleteService()" [disabled]="isSubmitting">
         <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
         Eliminar
       </button>
     </div>
   </div>
</ng-template>