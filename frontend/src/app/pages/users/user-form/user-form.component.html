<div class="animate-fade-in">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4">
    <div>
      <h1 class="h2 fw-bold mb-0">{{ isEditing ? 'Editar' : 'Nuevo' }} Usuario</h1>
      <p class="text-muted">{{ isEditing ? 'Modifica los datos del usuario' : 'Añade un nuevo usuario al sistema' }}</p>
    </div>
    <div>
      <a routerLink="/dashboard/users" class="btn btn-outline-secondary rounded-pill px-4">
        <i class="bi bi-arrow-left me-2"></i> Volver
      </a>
    </div>
  </div>

  <!-- Success message -->
  <div *ngIf="successMessage" class="alert alert-success mb-4">
    <i class="bi bi-check-circle-fill me-2"></i> {{ successMessage }}
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="alert alert-danger mb-4">
    <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
  </div>

  <!-- Loading state -->
  <div *ngIf="loading && !isEditing" class="text-center my-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2 text-muted fs-5">{{ isEditing ? 'Cargando usuario...' : 'Procesando...' }}</p>
  </div>

  <!-- User Form -->
  <div class="card border-0 shadow-sm" *ngIf="!loading || isEditing">
    <div class="card-body p-4">
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" autocomplete="off">
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="name" class="form-label">Nombre <span class="text-danger">*</span></label>
            <input
              type="text"
              id="name"
              formControlName="name"
              class="form-control"
              [ngClass]="{'is-invalid': hasError('name', 'required')}"
              placeholder="Introduzca el nombre"
            />
            <div *ngIf="hasError('name', 'required')" class="invalid-feedback">
              El nombre es obligatorio
            </div>
          </div>

          <div class="col-md-6">
            <label for="surnames" class="form-label">Apellidos <span class="text-danger">*</span></label>
            <input
              type="text"
              id="surnames"
              formControlName="surnames"
              class="form-control"
              [ngClass]="{'is-invalid': hasError('surnames', 'required')}"
              placeholder="Introduzca los apellidos"
            />
            <div *ngIf="hasError('surnames', 'required')" class="invalid-feedback">
              Los apellidos son obligatorios
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-control"
                [ngClass]="{'is-invalid': hasError('email', 'required') || hasError('email', 'email')}"
                placeholder="ejemplo@correo.com"
                autocomplete="false"
              />
              <div *ngIf="hasError('email', 'required')" class="invalid-feedback">
                El email es obligatorio
              </div>
              <div *ngIf="hasError('email', 'email')" class="invalid-feedback">
                El formato del email no es válido
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <label for="password" class="form-label">
              Contraseña 
              <ng-container *ngIf="isEditing">(Dejar en blanco para mantener la actual)</ng-container>
              <ng-container *ngIf="!isEditing"><span class="text-danger">*</span></ng-container>
            </label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-key"></i></span>
              <input
                type="password"
                id="password"
                formControlName="password"
                class="form-control"
                [ngClass]="{'is-invalid': hasError('password', 'required') || hasError('password', 'minlength')}"
                placeholder="Mínimo 6 caracteres"
                autocomplete="false"
              />
              <div *ngIf="hasError('password', 'required')" class="invalid-feedback">
                La contraseña es obligatoria
              </div>
              <div *ngIf="hasError('password', 'minlength')" class="invalid-feedback">
                La contraseña debe tener al menos 6 caracteres
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <label for="role" class="form-label">Rol <span class="text-danger">*</span></label>
            <select
              id="role"
              formControlName="role"
              class="form-select"
              [ngClass]="{'is-invalid': hasError('role', 'required')}"
            >
              <option value="" disabled selected>Seleccione un rol</option>
              <option *ngFor="let option of roleOptions" [value]="option.value">{{ option.label }}</option>
            </select>
            <div *ngIf="hasError('role', 'required')" class="invalid-feedback">
              El rol es obligatorio
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <a routerLink="/dashboard/users" class="btn btn-light rounded-pill px-4" 
             [class.disabled]="loading" 
             [attr.tabindex]="loading ? -1 : 0"
             [attr.aria-disabled]="loading ? 'true' : null"
             >
            <i class="bi bi-x-circle me-2"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-primary rounded-pill px-4" [disabled]="userForm.invalid || loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!loading" class="bi bi-check-circle me-2"></i>
            {{ isEditing ? 'Guardar Cambios' : 'Crear Usuario' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div> 